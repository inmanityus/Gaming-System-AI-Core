# NATS Server Production Configuration
# Peer Reviewed: GPT-5 Pro recommendations applied
# Purpose: Production-grade NATS cluster with TLS, AuthZ, JetStream

# Server Identity
server_name: "$INSTANCE_ID"

# Client Connections (TLS Required)
listen: 0.0.0.0:4222
max_payload: 1MB  # Enforce 1MB limit

# TLS Configuration (mTLS for services)
tls {
  cert_file: "/etc/nats/certs/server-cert.pem"
  key_file: "/etc/nats/certs/server-key.pem"
  ca_file: "/etc/nats/certs/ca-cert.pem"
  verify: true
  timeout: 5
  # Require client certificates from services
  verify_and_map: true
}

# Cluster Configuration (TLS)
cluster {
  name: "gaming-system-production"
  listen: 0.0.0.0:6222
  
  routes = [
    # Populated by user_data.sh based on ASG discovery
  ]
  
  tls {
    cert_file: "/etc/nats/certs/server-cert.pem"
    key_file: "/etc/nats/certs/server-key.pem"
    ca_file: "/etc/nats/certs/ca-cert.pem"
    verify: true
    timeout: 5
  }
  
  # Cluster authentication
  authorization {
    user: "natscluster"
    password: "$CLUSTER_PASSWORD"
  }
}

# Leafnode Configuration
leafnodes {
  listen: 0.0.0.0:7422
  
  tls {
    cert_file: "/etc/nats/certs/server-cert.pem"
    key_file: "/etc/nats/certs/server-key.pem"
    ca_file: "/etc/nats/certs/ca-cert.pem"
    verify: true
    timeout: 5
  }
}

# HTTP Monitoring (Secured)
http_port: 8222
http {
  # Basic auth for monitoring
  # In production: use mTLS or IP whitelist
}

# JetStream Configuration
jetstream {
  domain: "production"
  store_dir: "/var/lib/nats/jetstream"
  max_memory_store: 2GB
  max_file_store: 450GB
  
  # Unique server tag for R=3 placement across AZs
  # Set via environment: -tags "az:$AZ"
}

# Authentication & Authorization (NKey/JWT)
# Resolver URL points to account server
# For production: use decentralized JWT with operator key
operator: "/etc/nats/operator.jwt"
resolver: {
  type: full
  dir: "/etc/nats/jwt"
  allow_delete: false
  interval: "2m"
}

# Connection Limits & Protection
max_connections: 10000
max_subscriptions: 0  # Unlimited
max_pending: 64MB

# Per-connection limits
max_control_line: 4096
max_payload: 1MB

# Write Protection
write_deadline: "5s"

# Ping/Pong & Health
ping_interval: "15s"
ping_max: 3

# Lame Duck Mode (for rolling upgrades)
lame_duck_duration: "60s"
lame_duck_grace_period: "10s"

# Logging (structured JSON)
debug: false
trace: false
logtime: true
log_file: "/var/log/nats/nats-server.log"
log_size_limit: 100MB
syslog: false

# System Account (for monitoring and admin)
system_account: "$SYS"

# Accounts per service/tenant
# Defined via JWT resolver - samples:
#
# Account: gateway-account
#   Exports: none
#   Imports: all service subjects
#   Permissions: pub to svc.*.*, sub to response inboxes only
#
# Account: ai-integration-account
#   Exports: svc.ai.llm.v1.*
#   Imports: evt.* (events only)
#   Permissions: pub to svc.ai.llm.v1.*, evt.ai.*, sub to svc.ai.llm.v1.*, _INBOX.*
#
# Account: quest-account  
#   Exports: svc.quest.v1.*
#   Permissions: pub to svc.quest.v1.*, evt.quest.*, sub to svc.quest.v1.*, _INBOX.*
#
# See infrastructure/nats/accounts/ for full account definitions

# Performance Tuning
# Adjust based on load testing
max_slow_consumers: 10  # Before triggering slow consumer alerts
no_auth_timeout: 5  # Fail fast on missing auth

