{
  "commands": [
    "echo '=== Stopping any running training ==='",
    "pkill -f train_lora_adapter.py || true",
    "sleep 5",
    "",
    "echo '=== Backing up old code ==='",
    "if [ -f /home/ubuntu/training/train_lora_adapter.py ]; then",
    "  cp /home/ubuntu/training/train_lora_adapter.py /home/ubuntu/training/train_lora_adapter.py.backup",
    "fi",
    "",
    "echo '=== Downloading fixed code from S3 ==='",
    "cd /home/ubuntu",
    "aws s3 cp s3://body-broker-training-9728/code/training-fixed.tar.gz ./training-fixed.tar.gz",
    "",
    "echo '=== Extracting fixed code ==='",
    "tar -xzf training-fixed.tar.gz -C /home/ubuntu/training/",
    "",
    "echo '=== Verifying deployment ==='",
    "ls -la /home/ubuntu/training/",
    "head -20 /home/ubuntu/training/train_lora_adapter.py",
    "",
    "echo '=== Starting Vampire adapter training ==='",
    "cd /home/ubuntu/training",
    "nohup python3 train_lora_adapter.py --archetype vampire > /home/ubuntu/training/vampire_training.log 2>&1 &",
    "echo $! > /home/ubuntu/training/vampire_training.pid",
    "sleep 10",
    "",
    "echo '=== Checking training started ==='",
    "if [ -f /home/ubuntu/training/vampire_training.pid ]; then",
    "  pid=$(cat /home/ubuntu/training/vampire_training.pid)",
    "  if ps -p $pid > /dev/null; then",
    "    echo \"✅ Training started successfully (PID: $pid)\"",
    "    tail -50 /home/ubuntu/training/vampire_training.log",
    "  else",
    "    echo \"❌ Training process not running\"",
    "    cat /home/ubuntu/training/vampire_training.log",
    "    exit 1",
    "  fi",
    "else",
    "  echo \"❌ PID file not created\"",
    "  exit 1",
    "fi",
    "",
    "echo '=== GPU Status ==='",
    "nvidia-smi --query-gpu=index,name,utilization.gpu,memory.used,memory.total,temperature.gpu --format=csv,noheader"
  ]
}

